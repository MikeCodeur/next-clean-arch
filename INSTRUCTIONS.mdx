# Logging

### ğŸ’¡ Comprendre lâ€™importance de loguer correctement

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Le logging est une pratique essentielle dans le dÃ©veloppement d'applications, car il permet de comprendre ce qui se passe rÃ©ellement dans le systÃ¨me.

Un bon systÃ¨me de logs offre une visibilitÃ© sur les Ã©vÃ©nements clÃ©s, les erreurs, et les performances de lâ€™application, que ce soit en dÃ©veloppement ou en production.

En cas de problÃ¨me, les logs agissent comme une "boÃ®te noire" pour diagnostiquer rapidement les causes et rÃ©duire le temps de rÃ©solution.

Ils sont Ã©galement indispensables pour surveiller les comportements inattendus, dÃ©tecter des anomalies de sÃ©curitÃ©, et garantir une expÃ©rience utilisateur optimale.

Une stratÃ©gie de logging bien pensÃ©e fait donc partie intÃ©grante d'une application fiable et maintenable.

Exemple

- **DEBUG** : Informations dÃ©taillÃ©es utilisÃ©es pour le dÃ©bogage.
- **INFO** : Ã‰vÃ©nements normaux (succÃ¨s, actions importantes).
- **WARN** : Avertissements concernant des Ã©vÃ©nements inattendus mais non bloquants.
- **ERROR** : Erreurs bloquantes nÃ©cessitant une intervention immÃ©diate.
- **FATAL** : Erreurs critiques causant l'arrÃªt de l'application.

**Exemple d'usage :**

- DEBUG : "EntrÃ©e dans la fonction `updateProductService` avec `{ id: 123 }`."
- INFO : "Produit mis Ã  jour avec succÃ¨s."
- WARN : "Le champ `price` est manquant, valeur par dÃ©faut utilisÃ©e."
- ERROR : "Ã‰chec de la mise Ã  jour : produit introuvable."
- FATAL : "Connexion Ã  la base de donnÃ©es impossible."

### Il existe une RFC pour cela la [RFC 5424](https://www.rfc-editor.org/rfc/rfc5424.html)

## ProblÃ¨mes de `console`

1. Correspondance entre **`console`** et **RFC 5424 :**

| **Niveau RFC 5424** | **Code RFC** | **Console JS**    | **Notes**                                                                      |
| ------------------- | ------------ | ----------------- | ------------------------------------------------------------------------------ |
| **Emergency**       | 0            | âŒ Non disponible | Pas de mÃ©thode directe pour "Emergency" dans `console`.                        |
| **Alert**           | 1            | âŒ Non disponible | Pas de mÃ©thode directe pour "Alert".                                           |
| **Critical**        | 2            | âŒ Non disponible | Pas de mÃ©thode directe pour "Critical".                                        |
| **Error**           | 3            | `console.error()` | Correspond approximativement au niveau **Error**.                              |
| **Warning**         | 4            | `console.warn()`  | Correspond au niveau **Warning** pour des conditions non bloquantes.           |
| **Notice**          | 5            | âŒ Non disponible | Pas de mÃ©thode spÃ©cifique pour un niveau intermÃ©diaire comme "Notice".         |
| **Informational**   | 6            | `console.info()`  | Correspond au niveau **Informational** pour les logs normaux et non critiques. |
| **Debug**           | 7            | `console.debug()` | Correspond au niveau **Debug** pour des informations dÃ©taillÃ©es de diagnostic. |

`Console` nâ€™est pas 100% standard Ã  cette RFC mais elle couvre un grand nombre de cas.

Correspondance entre **`console`** et **RFC 5424 :**

1. Il nâ€™y pas de `mÃ©tadata` et de `structure` (formatage)

Ce qui peut compliquer lâ€™analyse

1. En utilisant `console`, nous sommes dÃ©pendant de la plateforme

En effet il faut que la plateforme prenne en compte la sortie standard (stdout/stderr) et il faut quâ€™elle ait un outils dâ€™analyse

- Vercel par exemple :

![course/vercel-log.png](course/vercel-log.png)

[https://vercel.com/docs/observability/runtime-logs](https://vercel.com/docs/observability/runtime-logs)

Mais si lâ€™application est hÃ©bergÃ© â€œmanuellementâ€ (sans serverless) il faut gÃ©rer cela dans des fichiers logs ou via un service externe (Loggly etc â€¦)

## Exercice

- **ğŸ‘¨â€âœˆï¸** Hugo le chef de projet te demande de mettre en place un systÃ¨me de log pour pouvoir tracer ce quâ€™il se passe dans lâ€™application

Dans un premier temps nous allons utiliser `console` pour `logger` les informations importantes dans les services. Nous allons utiliser les 3 niveaux de bases

- `info`
- `warning`
- `error`

ğŸ¶ Met en place les logs pour la partie `â€˜productâ€™` au niveau

- `service` (info, warning, error)

Avec le pattern : `NOM_FONCTION : PARAMS DATA` par exemple

```tsx
console.info(`createProductWithCategoryService : params ${productName} ${categoryName}`)
```

Fichiers

- `services/product-service`

## Bonus

### 1. ğŸš€ Log avec Winston (formatage)

`Console` Ã©tant limitÃ©, il existe des librairies plus avancÃ© comme `winston`. Avantages :

Winston est une bibliothÃ¨que de logging flexible, puissante et largement adoptÃ©e dans lâ€™Ã©cosystÃ¨me Node.js. Elle offre toutes les fonctionnalitÃ©s nÃ©cessaires pour capturer, structurer et transporter vos logs, que ce soit pour un petit projet ou une application Ã  grande Ã©chelle. Winston permet de rÃ©pondre aux besoins suivants :

- **Multi-transport** : Envoyez vos logs Ã  plusieurs destinations (console, fichiers, services cloud, bases de donnÃ©es).
- **Personnalisation** : CrÃ©ez des formats et des niveaux de log adaptÃ©s Ã  vos besoins.
- **Performance** : Winston est optimisÃ© pour gÃ©rer des volumes de logs importants sans compromettre les performances.
- **Ã‰volutivitÃ©** : IdÃ©al pour une application Ã©voluant dâ€™un dÃ©ploiement local Ã  une infrastructure distribuÃ©e.

ğŸ¶ Dans un premier temps utilise le logger `Winston` avec un transport par default (`la console`) dans le `product-service`

```tsx
//logger.ts
export const logger = winston.createLogger({
  transports: [new winston.transports.Console()],
})
//{"level":"info","message":"getProductsPaginationService : params 4 0"}
```

Product service : Remplace la `console` par le `logger`

```tsx
//product-service
import {logger} from '@/lib/logger'

//console.info(`getProductsService : params`)
logger.info(`getProductsService : params`)
```

ğŸ¶ Dans un second temps : **Enrichie le logger**

1. Ajoute le niveau de log (`info`)

Permet de dÃ©finir un niveau a partir duquel le systÃ¨me log

```tsx
export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
})
```

Fichiers `.env`

```tsx
//.env.develoment
LOG_LEVEL=debug
//.env.production
LOG_LEVEL=info
// en developpement on va tout logger
// pas en production car trop lourd
```

1. Formatage des logs : cli

Essaye ce formatage : `winston.format.cli()` formatte pour le terminal

```tsx
export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.cli()
})
```

1. Formatage des logs : Combine

Essaye en combinant les formatages avec `winston.format.combine()`

```tsx
export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
	format: winston.format.combine(
    winston.format.timestamp({
      format: 'YYYY-MM-DD HH:mm:ss',
    }),
    winston.format.colorize({level: true}),
    winston.format.printf(({timestamp, level, message}) => {
      return ` ${timestamp} [${level}]: ${message}`
    })
  ),
})
```

Fichiers

- `lib/logger.ts`
- `services/product-service`

### 2. ğŸš€ Winston MetaData

Il arrive souvent que lâ€™on ai a loguer les donnÃ©e en entrÃ©e comme par exemple

```tsx
logger.info(`createProductService : params ${data} `)
// probleme
// createProductService : params [object Object]
```

on souhaite pouvoir faire

```tsx
logger.info(`createProductService : params`, data)
//data = metadata
```

- **ğŸ¶** Adapte le logger pour prendre en compte les metadata

```tsx
 winston.format.printf(({timestamp, level, message, ...metadata}) => {
      const formattedMetadata =
        Object.keys(metadata).length > 0 ? ` | ${JSON.stringify(metadata)}` : ''
      return ` ${timestamp} [${level}]: ${message} ${formattedMetadata}`
    })
```

Fichiers

- `lib/logger.ts`
- `services/product-service`

### 3. ğŸš€ fichiers logs

Pour analyser plus facilement il est utile dâ€™avoir des fichiers contenant uniquement certains niveau dâ€™erreur.

**ğŸ‘¨â€âœˆï¸ Hugo te demande dâ€™implÃ©menter la configuration qui permettra dâ€™avoir :**

- `application.log`, toute les log
- `error.log`, toute les `errors`
- `debug.log`, toute les traces de `debugs`

**ğŸ¶ Dans la partie transport ajoute `new winston.transports.File`**

```tsx
export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  transports: [
	  new winston.transports.Console()
	  new winston.transports.File( .... )
  ],
})
```

Pour cela tu dois d'abord crÃ©er les fichiers

```tsx
import fs from 'node:fs'
import path from 'node:path'
// DÃ©finir le chemin du dossier et du fichier log
const logDir = path.resolve('./logs') // Dossier courant /logs
if (!fs.existsSync(logDir)) {
  fs.mkdirSync(logDir) // CrÃ©e le dossier "logs" s'il n'existe pas
}
const logFile = path.join(logDir, 'application.log')
const logErrorFile = path.join(logDir, 'error.log')
const logDebugFile = path.join(logDir, 'debug.log')
```

et ensuite spÃ©cifier le fichier

```tsx
new winston.transports.File({
      filename: logFile,
      format ...
```

## Aller plus loin

Il sera possible de choisir un service externe comme `loggly` pour envoyer les log

```tsx
  transports: [
    new winston.transports.Console(), // Utilise la sortie console pour Vercel
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.splat(),
        winston.format.cli()
      ),
    }),
    // Other logger
     new Loggly({
       token: 'your-loggly-token', // Remplace par ton token Loggly
       subdomain: 'your-loggly-subdomain', // Remplace par ton sous-domaine Loggly
       tags: ['Winston-NodeJS'], // Ajoute des tags pour identifier les logs
       json: true,  // Envoie les logs au format JSON
     }),
  ],
})
```

Il est possible dâ€™utiliser cette lib pour la rotation de fichier

[https://github.com/winstonjs/winston-daily-rotate-file](https://github.com/winstonjs/winston-daily-rotate-file)

```tsx
const transport: DailyRotateFile = new DailyRotateFile({
    filename: 'application-%DATE%.log',
    datePattern: 'YYYY-MM-DD-HH',
    zippedArchive: true,
    maxSize: '20m',
    maxFiles: '14d'
});
```

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis).
