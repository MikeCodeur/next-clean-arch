# Les interceptors

### üí° Comprendre les interceptors

## üìù Tes notes

Detaille ce que tu as appris ici,¬†sur¬†une¬†page¬†[Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Un hello world en HTML:

Les `interceptors` sont une technique puissante qui permettent d‚Äôintercepter et de modifier le comportement des appels de fonctions ou de m√©thodes. Ils sont particuli√®rement utiles pour g√©rer des pr√©occupations transversales comme le **logging**, la **gestion des erreurs**, la **validation**, ou encore le **profilage des performances** sans alourdir le code m√©tier.

Sans `interceptor`, ajouter des logs dans chaque fonction peut rapidement rendre le code confus, redondant, et difficile √† maintenir. En revanche, un interceptor centralise cette logique de mani√®re √©l√©gante, am√©liorant la clart√© et la lisibilit√© du code.

### Exemple : Logging sans Interceptor

```tsx

export const updateProductService = async ({ id, name }) => {
  logger.info(`Appel de updateProductService avec id=${id}, name=${name}`);
  try {
    if (!id || !name) throw new Error('Invalid arguments');
    const result = { id, name, status: 'updated' };
    logger.info(`R√©sultat : ${JSON.stringify(result)}`);
    return result;
  } catch (error) {
    logger.error(`Erreur : ${error.message}`);
    throw error;
  }
};

```

Chaque fonction est alourdie par des appels r√©p√©titifs √† `logger`.

### Logging avec Interceptor

Avec un `interceptor`, updateProductService ne contient pas de code li√© au logging. Cette logique est externalis√©e, dans cette exemple la logique de `logging` est dans `interceptor.ts` :

```jsx
import {serviceInterceptor} from './interceptor'

const result = await serviceInterceptor.updateProductService({
  id: 123,
  name: 'New Product',
})
```

L‚Äô`interceptor` logge automatiquement :

1. Les **arguments** pass√©s √† la fonction.
2. Le **r√©sultat** de la fonction.
3. Les **erreurs** en cas d‚Äô√©chec.

### Avantages des Interceptors

1. **Clart√© :** Le code m√©tier reste concentr√© sur sa logique, sans distractions.
2. **R√©duction de la redondance :** La logique commune (comme le logging) est centralis√©e.
3. **Extensibilit√© :** Les interceptors peuvent √™tre enrichis pour inclure des fonctionnalit√©s suppl√©mentaires (profiling, validation, etc.).
4. **Maintenance simplifi√©e :** Toute modification de la logique transverse se fait en un seul endroit.

Les interceptors rendent votre code plus propre, maintenable et √©volutif, tout en assurant un suivi pr√©cis des comportements.

## Comment cr√©er un interceptor ?

Pour cr√©er un intercepter on peut utiliser [un proxy](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy)

- Exemple simple

```tsx
const target = { name: 'Alice', age: 25 };

const handler = {
  get(obj, prop) {
    console.log(`Acc√®s √† la propri√©t√© : ${prop}`);
    return obj[prop];
  },
};

const proxy = new Proxy(target, handler);

console.log(proxy.name); // "Acc√®s √† la propri√©t√© : name", puis "Alice"
console.log(proxy.age);  // "Acc√®s √† la propri√©t√© : age", puis 25

```

Le proxy nous permettra de mettre en place l‚Äôinterceptor

## Exercice

Pour les besoins de l‚Äôexercice nous avons mis en place un `proxy` qui n‚Äôalt√®re pas les fonctions originales

```tsx
const productServiceInterceptor = new Proxy(productServiceMethods, {
  get(target: ServiceMethods, property: keyof ServiceMethods) {
    const originalMethod = target[property] as unknown
    // V√©rifier que la propri√©t√© est bien une fonction
    if (typeof originalMethod === 'function') {
      // Retourner une nouvelle fonction qui appelle l'originale sans modification
      return async function (...args: unknown[]) {
        // Appel de la m√©thode originale sans aucun changement
        return originalMethod.apply(target, args)
      }
    }
    // Retourner la propri√©t√© originale si ce n'est pas une fonction
    return originalMethod
  },
})

export default productServiceInterceptor // as ServiceMethods
```

Pour forcer l‚Äôappel √† `l‚Äôinterceptor`, nous avons ajouter la r√®gles ESlint suivante pour interdire `product-service` dans les pr√©sentation

```tsx
 {
    files: ['src/app/**/*.{ts,tsx}'],
    rules: {
      'no-restricted-imports': [
        'error',
        {
          patterns: ['@/db/*', 'drizzle-orm', '@/services/product-service'],
        },
      ],
    },
  },
```

Nous avons modifier les appels dans la pr√©sentation

```tsx
// import {
//   createProductWithCategoryService,
//   deleteProductService,
//   getCategoriesService,
//   getProductByNameService,
//   getProductsService,
//   persistProductService,
// } from '@/services/product-service'
import productServiceInterceptor from '@/services/interceptors/product-service-logger-interceptor'

 const product =
      await productServiceInterceptor.createProductWithCategoryService(
        parsed.data.productName,
        parsed.data.categoryName
      )
    revalidatePath('/shop-admin')
```

- **üê∂ Dans cet exercice tu vas devoir utiliser le logger winston dans l‚Äôinterceptor** `product-service-logger-interceptor`

Fichiers

- `service/interceptors/product-service-logger-interceptor.ts`

## Bonus

### 1. üöÄ Gerer les `AuthorizationError`

Il est possible d‚Äôaffiner les log en fonction du type d‚Äôerror. Dans notre cas nous allons affiner sur les `authorizationError`

```tsx
 if (error instanceof AuthorizationError) {
      logger.error(
        `Authorisation Erreur dans la m√©thode ${String(property)} :`,
        (error as Error).message
      )
    } else {
      logger.error(
        `Erreur dans la m√©thode ${String(property)} :`,
        (error as Error).message
      )
      logger.debug(
        `Erreur dans la m√©thode ${String(property)} : ${(error as Error).message}`,
        error
      )
    }
```

- **üê∂ impl√©mente cela**

Fichiers

- `service/interceptors/product-service-logger-interceptor.ts`

## Aller plus loin

## Ils vont t‚Äôaider

- **üê∂ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ü§ñ Ash le Robot** : _Ash le Robot te donnera du code utile._
- **üöÄ Julia La roquette** : _Julia te donnera des d√©fis suppl√©mentaires._
- **‚õèÔ∏è Hulk le Marteau** : _Quand du code √† supprimer est pr√©sent_
- **üë®‚Äç‚úàÔ∏è Hugo le chef de projet** : _Va t'aider sur les sp√©cifications du projet_

## üêú Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis).

```jsx

```
