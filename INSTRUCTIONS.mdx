# Logging

### üí° Comprendre l‚Äôimportance de loguer correctement

## üìù Tes notes

Detaille ce que tu as appris ici,¬†sur¬†une¬†page¬†[Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Le logging est une pratique essentielle dans le d√©veloppement d'applications, car il permet de comprendre ce qui se passe r√©ellement dans le syst√®me.

Un bon syst√®me de logs offre une visibilit√© sur les √©v√©nements cl√©s, les erreurs, et les performances de l‚Äôapplication, que ce soit en d√©veloppement ou en production.

En cas de probl√®me, les logs agissent comme une "bo√Æte noire" pour diagnostiquer rapidement les causes et r√©duire le temps de r√©solution.

Ils sont √©galement indispensables pour surveiller les comportements inattendus, d√©tecter des anomalies de s√©curit√©, et garantir une exp√©rience utilisateur optimale.

Une strat√©gie de logging bien pens√©e fait donc partie int√©grante d'une application fiable et maintenable.

Exemple

- **DEBUG** : Informations d√©taill√©es utilis√©es pour le d√©bogage.
- **INFO** : √âv√©nements normaux (succ√®s, actions importantes).
- **WARN** : Avertissements concernant des √©v√©nements inattendus mais non bloquants.
- **ERROR** : Erreurs bloquantes n√©cessitant une intervention imm√©diate.
- **FATAL** : Erreurs critiques causant l'arr√™t de l'application.

**Exemple d'usage :**

- DEBUG : "Entr√©e dans la fonction `updateProductService` avec `{ id: 123 }`."
- INFO : "Produit mis √† jour avec succ√®s."
- WARN : "Le champ `price` est manquant, valeur par d√©faut utilis√©e."
- ERROR : "√âchec de la mise √† jour : produit introuvable."
- FATAL : "Connexion √† la base de donn√©es impossible."

### Il existe une RFC pour cela la [RFC 5424](https://www.rfc-editor.org/rfc/rfc5424.html)

## Probl√®mes de `console`

1. Correspondance entre **`console`** et **RFC 5424 :**

| **Niveau RFC 5424** | **Code RFC** | **Console JS**    | **Notes**                                                                      |
| ------------------- | ------------ | ----------------- | ------------------------------------------------------------------------------ |
| **Emergency**       | 0            | ‚ùå Non disponible | Pas de m√©thode directe pour "Emergency" dans `console`.                        |
| **Alert**           | 1            | ‚ùå Non disponible | Pas de m√©thode directe pour "Alert".                                           |
| **Critical**        | 2            | ‚ùå Non disponible | Pas de m√©thode directe pour "Critical".                                        |
| **Error**           | 3            | `console.error()` | Correspond approximativement au niveau **Error**.                              |
| **Warning**         | 4            | `console.warn()`  | Correspond au niveau **Warning** pour des conditions non bloquantes.           |
| **Notice**          | 5            | ‚ùå Non disponible | Pas de m√©thode sp√©cifique pour un niveau interm√©diaire comme "Notice".         |
| **Informational**   | 6            | `console.info()`  | Correspond au niveau **Informational** pour les logs normaux et non critiques. |
| **Debug**           | 7            | `console.debug()` | Correspond au niveau **Debug** pour des informations d√©taill√©es de diagnostic. |

`Console` n‚Äôest pas 100% standard √† cette RFC mais elle couvre un grand nombre de cas.

Correspondance entre **`console`** et **RFC 5424 :**

1. Il n‚Äôy pas de `m√©tadata` et de `structure` (formatage)

Ce qui peut compliquer l‚Äôanalyse

1. En utilisant `console`, nous sommes d√©pendant de la plateforme

En effet il faut que la plateforme prenne en compte la sortie standard (stdout/stderr) et il faut qu‚Äôelle ait un outils d‚Äôanalyse

- Vercel par exemple :

![course/vercel-log.png](course/vercel-log.png)

[https://vercel.com/docs/observability/runtime-logs](https://vercel.com/docs/observability/runtime-logs)

Mais si l‚Äôapplication est h√©berg√© ‚Äúmanuellement‚Äù (sans serverless) il faut g√©rer cela dans des fichiers logs ou via un service externe (Loggly etc ‚Ä¶)

## Exercice

- **üë®‚Äç‚úàÔ∏è** Hugo le chef de projet te demande de mettre en place un syst√®me de log pour pouvoir tracer ce qu‚Äôil se passe dans l‚Äôapplication

Dans un premier temps nous allons utiliser `console` pour `logger` les informations importantes dans les services. Nous allons utiliser les 3 niveaux de bases

- `info`
- `warning`
- `error`

üê∂ Met en place les logs pour la partie `‚Äòproduct‚Äô` au niveau

- `service` (info, warning, error)

Avec le pattern : `NOM_FONCTION : PARAMS DATA` par exemple

```tsx
console.info(`createProductWithCategoryService : params ${productName} ${categoryName}`)
```

Fichiers

- `services/product-service`

## Bonus

### 1. üöÄ Log avec Winston (formatage)

`Console` √©tant limit√©, il existe des librairies plus avanc√© comme `winston`. Avantages :

Winston est une biblioth√®que de logging flexible, puissante et largement adopt√©e dans l‚Äô√©cosyst√®me Node.js. Elle offre toutes les fonctionnalit√©s n√©cessaires pour capturer, structurer et transporter vos logs, que ce soit pour un petit projet ou une application √† grande √©chelle. Winston permet de r√©pondre aux besoins suivants :

- **Multi-transport** : Envoyez vos logs √† plusieurs destinations (console, fichiers, services cloud, bases de donn√©es).
- **Personnalisation** : Cr√©ez des formats et des niveaux de log adapt√©s √† vos besoins.
- **Performance** : Winston est optimis√© pour g√©rer des volumes de logs importants sans compromettre les performances.
- **√âvolutivit√©** : Id√©al pour une application √©voluant d‚Äôun d√©ploiement local √† une infrastructure distribu√©e.

üê∂ Dans un premier temps utilise le logger `Winston` avec un transport par default (`la console`) dans le `product-service`

```tsx
//logger.ts
export const logger = winston.createLogger({
  transports: [new winston.transports.Console()],
})
//{"level":"info","message":"getProductsPaginationService : params 4 0"}
```

Product service : Remplace la `console` par le `logger`

```tsx
//product-service
import {logger} from '@/lib/logger'

//console.info(`getProductsService : params`)
logger.info(`getProductsService : params`)
```

üê∂ Dans un second temps : **Enrichie le logger**

1. Ajoute le niveau de log (`info`)

Permet de d√©finir un niveau a partir duquel le syst√®me log

```tsx
export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
})
```

Fichiers `.env`

```tsx
//.env.develoment
LOG_LEVEL=debug
//.env.production
LOG_LEVEL=info
// en developpement on va tout logger
// pas en production car trop lourd
```

1. Formatage des logs : cli

Essaye ce formatage : `winston.format.cli()` formatte pour le terminal

```tsx
export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.cli()
})
```

1. Formatage des logs : Combine

Essaye en combinant les formatages avec `winston.format.combine()`

```tsx
export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
	format: winston.format.combine(
    winston.format.timestamp({
      format: 'YYYY-MM-DD HH:mm:ss',
    }),
    winston.format.colorize({level: true}),
    winston.format.printf(({timestamp, level, message}) => {
      return ` ${timestamp} [${level}]: ${message}`
    })
  ),
})
```

Fichiers

- `lib/logger.ts`
- `services/product-service`

### 2. üöÄ Winston MetaData

Il arrive souvent que l‚Äôon ai a loguer les donn√©e en entr√©e comme par exemple

```tsx
logger.info(`createProductService : params ${data} `)
// probleme
// createProductService : params [object Object]
```

on souhaite pouvoir faire

```tsx
logger.info(`createProductService : params`, data)
//data = metadata
```

- **üê∂** Adapte le logger pour prendre en compte les metadata

```tsx
 winston.format.printf(({timestamp, level, message, ...metadata}) => {
      const formattedMetadata =
        Object.keys(metadata).length > 0 ? ` | ${JSON.stringify(metadata)}` : ''
      return ` ${timestamp} [${level}]: ${message} ${formattedMetadata}`
    })
```

Fichiers

- `lib/logger.ts`
- `services/product-service`

### 3. üöÄ fichiers logs

Pour analyser plus facilement il est utile d‚Äôavoir des fichiers contenant uniquement certains niveau d‚Äôerreur.

**üë®‚Äç‚úàÔ∏è Hugo te demande d‚Äôimpl√©menter la configuration qui permettra d‚Äôavoir :**

- `application.log`, toute les log
- `error.log`, toute les `errors`
- `debug.log`, toute les traces de `debugs`

**üê∂ Dans la partie transport ajoute `new winston.transports.File`**

```tsx
export const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  transports: [
	  new winston.transports.Console()
	  new winston.transports.File( .... )
  ],
})
```

Pour cela tu dois d'abord cr√©er les fichiers

```tsx
import fs from 'node:fs'
import path from 'node:path'
// D√©finir le chemin du dossier et du fichier log
const logDir = path.resolve('./logs') // Dossier courant /logs
if (!fs.existsSync(logDir)) {
  fs.mkdirSync(logDir) // Cr√©e le dossier "logs" s'il n'existe pas
}
const logFile = path.join(logDir, 'application.log')
const logErrorFile = path.join(logDir, 'error.log')
const logDebugFile = path.join(logDir, 'debug.log')
```

et ensuite sp√©cifier le fichier

```tsx
new winston.transports.File({
      filename: logFile,
      format ...
```

## Aller plus loin

Il sera possible de choisir un service externe comme `loggly` pour envoyer les log

```tsx
  transports: [
    new winston.transports.Console(), // Utilise la sortie console pour Vercel
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.splat(),
        winston.format.cli()
      ),
    }),
    // Other logger
     new Loggly({
       token: 'your-loggly-token', // Remplace par ton token Loggly
       subdomain: 'your-loggly-subdomain', // Remplace par ton sous-domaine Loggly
       tags: ['Winston-NodeJS'], // Ajoute des tags pour identifier les logs
       json: true,  // Envoie les logs au format JSON
     }),
  ],
})
```

Il est possible d‚Äôutiliser cette lib pour la rotation de fichier

[https://github.com/winstonjs/winston-daily-rotate-file](https://github.com/winstonjs/winston-daily-rotate-file)

```tsx
const transport: DailyRotateFile = new DailyRotateFile({
    filename: 'application-%DATE%.log',
    datePattern: 'YYYY-MM-DD-HH',
    zippedArchive: true,
    maxSize: '20m',
    maxFiles: '14d'
});
```

## Ils vont t‚Äôaider

- **üê∂ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ü§ñ Ash le Robot** : _Ash le Robot te donnera du code utile._
- **üöÄ Julia La roquette** : _Julia te donnera des d√©fis suppl√©mentaires._
- **‚õèÔ∏è Hulk le Marteau** : _Quand du code √† supprimer est pr√©sent_
- **üë®‚Äç‚úàÔ∏è Hugo le chef de projet** : _Va t'aider sur les sp√©cifications du projet_

## üêú Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis).
