# Data Acces Layer - Data Transfert Object

### ğŸ’¡ Comprendre la DAL et DTOs

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans une architecture n-tiers, il est logique de penser que la couche de prÃ©sentation appelle la couche service pour rÃ©cupÃ©rer les donnÃ©es de la maniÃ¨re suivante

![/course/3-layers.png](/course/3-layers.png)

Ce model est valable mais il faut faire attention Ã  quelques points.

- gestion du cache.
- exposition des donnÃ©es sensible Ã  lâ€™ui.
- As t-on le droit, la session est elle valide ?

Exemple avec la page des derniers utilisateurs inscris : [http://localhost:3000/last-users](http://localhost:3000/last-users)

```tsx
//(public)/last-user
export default async function Page() {
  const lastUsers = await getPublicLastUsers()
  return (
    <div className="mx-auto max-w-2xl p-6 text-lg">
      <RecentUsersList users={lastUsers} />
    </div>
  )
}
```

- Ici nous faisons appel Ã  `getPublicLastUsers` qui fait appel `getAllUsersDao`. Un requÃªte qui rÃ©cupÃ¨re **toutes les donnÃ©es utilisateurs** en base de donnÃ©es.

Du coup nous passons toutes les donnÃ©es (mÃªme les donnÃ©es sensibles comme le `password` Ã  la vue).

On pourrait changer les requÃªtes `getAllUsersDao` mais rien ne nous dit que dans certains cas nous aurons besoins des autres champs.

Pour gÃ©rer cela, nous allons introduire une nouvelle couche : `DAL - Data Access Layer`. Cette couche isole la prÃ©sentation (Next / React etc â€¦ et le service)

![/course/3-layers-1.png](/course/3-layers-1.png)

A lâ€™heure actuelle nous avons dans le service `auth-service` la fonction `getConnectedUser.` Cette fonction gÃ¨re le `cache`

```tsx
import {cache} from 'react'
//
export const getConnectedUser = cache(async () => {
  try {
    const user = await getAuthUser()
    console.log('getConnectedUser', user)
    return user
  } catch (error) {
    console.error('Failed to fetch user', error)
    return
  }
})
```

Le problÃ¨me est que nous introduisons une dÃ©pendance Ã  `React` dans le service, nous allons interdire cela avec la rÃ¨gle :

```tsx
//eslint
{
    files: ['src/services/**/*.{ts,tsx}'],
    rules: {
      'no-restricted-imports': [
        'error',
        {
          paths: [
            {
              name: 'react',
              importNames: ['cache'],
              message:
                'Lâ€™utilisation de `cache` depuis `react` est interdite dans les services.',
            },
          ],
        },
      ],
    },
  },
```

Nous avons dÃ©placer toutes les fonctions utilisant le `cache react` dans `src/app/dal/user-dal`. Notre architecture ressemble maintenant Ã  :

![/course/3-layers-2.png](/course/3-layers-2.png)

Lâ€™accÃ¨s aux donnÃ©es (lecture) depuis les composant `React` passent par la couche `DAL`. Concernant les mutations elles ne passent pas par la DAL. (pas de cache ni de DTO)

## Exercice

Dans un premier temps nous allons modifier `getConnectedUser` pour quâ€™elle ne retourne plus toutes les donnÃ©es de la base de donnÃ©es. Pour cela nous allons utiliser un DTO(Data Transfer Object).

Câ€™est souvent un fonction qui convertie vers un type plus `safe` pour la vue.

```tsx
export function userDTO(user?: User): UserDTO | undefined {
 ...
}
```

**ğŸ¶ ImplÃ©mente le DTO pour ne retourner que**

- le nom
- lâ€™email
- le role

Fichiers

- `app/dal/user-dal.ts`

## Bonus

### 1. ğŸš€ Liste de Users

Adapte pour que [http://localhost:3000/last-users](http://localhost:3000/last-users) affiche les DTO et non le user de bdd.

CrÃ©er une fonction

```tsx
export function usersDTO(users?: User[]): UserDTO[] {

}
```

Remplace le `password` dans la vue par le rÃ´le

```tsx
 <TooltipContent>{`Avatar for ${user.role}`}</TooltipContent>
```

Fichiers

- `app/dal/user-dal.ts`

### 2. ğŸš€ VisibilitÃ© des champs

Les DTO peuvent aussi filtrer les champs en fonction de critÃ¨res comme le rÃ´le.

- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet te demande pour la liste des user** [http://localhost:3000/last-users](http://localhost:3000/last-users) dâ€™afficher le rÃ´le uniquement pour les ADMIN
- **ğŸ¶ Adapte le DTO**

En crÃ©ant une fonction `canSeeRole` qui utilise la fonction `isAuthUserAdmin` du service autorisation.

La rÃ¨gle : Si pas admin alors le champs rÃ´le est non visible

Fichiers

- `app/dal/user-dal.ts`

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis).
