# Autorisation

### ğŸ’¡ Mettre en place la couche dâ€™authorization

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

L'**autorisation** est un concept fondamental en dÃ©veloppement d'applications, permettant de contrÃ´ler **qui peut faire quoi** dans un systÃ¨me. Contrairement Ã  l'authentification, qui vÃ©rifie l'identitÃ© d'un utilisateur, l'autorisation dÃ©termine ses **permissions spÃ©cifiques**, comme accÃ©der Ã  des ressources ou effectuer des actions.

Ce module organise la logique d'autorisation en couches claires et rÃ©utilisables, en combinant des vÃ©rifications de rÃ´les (ex. : admin, manager) et de propriÃ©tÃ© (ex. : utilisateur propriÃ©taire d'une ressource).

En centralisant ces rÃ¨gles, il garantit une meilleure **sÃ©curitÃ©**, **lisibilitÃ©**, et **maintenance** du code. L'objectif est de rendre les autorisations flexibles, extensibles et cohÃ©rentes dans toute l'application.

Il existe de nombreuses maniÃ¨res de gÃ©rer lâ€™autorisation dans des applications citons en quelques uns

- **ACL (Access Control List)**
- **RBAC (Role-Based Access Control)**
- **ABAC (Attribute-Based Access Control)**
- **DAC (Discretionary Access Control)**
- **MAC (Mandatory Access Control)**
- **PBAC (Policy-Based Access Control)**
- **CBAC (Context-Based Access Control)**
- **LAC (Logic-Based Access Control)**

Dans notre cas ici nous implÃ©menterons du RBAC (basÃ© sur les Roles)

Dans lâ€™authentification, nous avons dÃ©jÃ  ajoutÃ© `role` sur le `USER`

```tsx
export enum RoleEnum {
  USER = 'USER',
  GUEST = 'GUEST',
  REDACTOR = 'REDACTOR',
  MODERATOR = 'MODERATOR',
  MANAGER = 'MANAGER',
  ADMIN = 'ADMIN',
  SUPER_ADMIN = 'SUPER_ADMIN',
}
```

Et nous avons dÃ©jÃ  des protections au niveau des routes avec les HOC suivants

- `withAuth` : VÃ©rifie que le user est connectÃ© (sans vÃ©rification de rÃ´le)
- `withAuthAdmin`: VÃ©rifie que le user a le rÃ´le `ADMIN`
- `withAuthModerator`: VÃ©rifie que le user a le rÃ´le `MODERATOR`
- `withAuthRedactor`: VÃ©rifie que le user a le rÃ´le `REDACTOR`
- `withAuthManager`: VÃ©rifie que le user a le rÃ´le `MANAGER`

Câ€™est de lâ€™autorisation au niveau de la prÃ©sentation, par blocage de route, câ€™est un bon dÃ©but mais câ€™est nâ€™est pas assez fin, cela ne permet pas de protÃ©ger la couche service (que lâ€™on pourrait par exemple appeler depuis un `Server Action`)

Les services doivent vÃ©rifier que lâ€™utilisateur est autorisÃ© a exÃ©cuter la fonction par exemple

### **RÃ´le : `GUEST`**

- Le **Visiteur (Guest)** peut :
  - AccÃ©der aux ressources publiques

### **RÃ´le : `USER`**

- L'**Utilisateur standard (User)** peut :
  - AccÃ©der aux ressources publiques
  - Voir ses propres informations
  - Modifier uniquement ses propres informations personnelles (nom, email, mot de passe).

### **RÃ´le : `ADMIN`**

- L'**Admin** peut :
  - GÃ©rer tous les utilisateurs de la plateforme (ajout, modification, suppression).
  - AccÃ©der Ã  toutes les ressources sans restrictions (documents, projets, utilisateurs).
  - Modifier les permissions des autres utilisateurs (par exemple, passer un `USER` en `MANAGER`).
  - Configurer les paramÃ¨tres globaux de l'application (paramÃ¨tres systÃ¨me, intÃ©grations, etc.).

Note : Pour les besoins de lâ€™exercice nous avons changÃ© touts les

- `withAuthManager` `withAuthAdmin` etc en `withAuth` pour pouvoir accÃ©der aux routes et voir les comportements.

## Exercice

ğŸ‘¨â€âœˆï¸ Hugo le chef de projet te demande te demande dâ€™implÃ©menter les rÃ¨gles suivantes pour lâ€™accÃ¨s au compte bancaire : [http://localhost:3000/bank/](http://localhost:3000/bank/)

- Le propriÃ©taire du compte (`authUser`) peut lire
- Les Admin (ou supÃ©rieur) peuvent lire tous les comptes

Pour simplifier lâ€™exercice : la route :

- [http://localhost:3000/bank/](http://localhost:3000/bank/) redirige vers [http://localhost:3000/bank/UID](http://localhost:3000/bank/UID)
- UID et le user ID (par default le user id connectÃ©)

Pour tester lâ€™autorisation il nous suffira de changer de UID dans URL

**ğŸ¶ Etape 1 :** `authorization-service.ts`

ImplÃ©mente les fonctions suivantes :

- `isAdminOrOwner` : Le user est il un admin ou propriÃ©taire de la ressource
- `canReadOwn` : Le user peut il lire ses propres ressources ? (base toi sur `isAdminOrOwner` )
- `canReadBankAccount` : Le user peut il lire le `bankAccount` (base toi sur `canReadOwn` )

**ğŸ¶ Etape 2 :** `user-service.ts`

Modifie la fonction `getBankAccountByUidService` et protÃ©geant avec `canReadBankAccount`

**ğŸ¶ Etape 3: `bank/[uid]page**.ts`

Adapte le code pour rÃ©diger vers `restricted` si une erreur est levÃ©e ou `NotFound` si pas de compte bancaire

Fichiers

- `services/authorization/authorization-service.ts`
- `services/user-service.ts`
- `(dashboard)/bank/[uid]/page.ts`

## Bonus

### 1. ğŸš€ DiffÃ©rencier les erreurs techniques de lâ€™autorisation

Il arrive quâ€™il y est des erreurs techniques qui soient levÃ©es. (AccÃ¨s en base de donnÃ©es ou autre)

Nous voulons les diffÃ©rencier de lâ€™autorisation

Pour cela nous avons un classe spÃ©ciale :

```tsx
//authorization Error
export class AuthorizationError extends Error {
  constructor(message: string = 'AccÃ¨s non autorisÃ©.') {
    super(message)
    this.name = 'AuthorizationError'
  }
}

```

- **ğŸ¶** Dans les services, lÃ¨ve une `AuthorizationError` au lieu dâ€™une `error`

Adapte ensuite la route pour gÃ©rer

- NotFound
- Restricted
- Error technique

Pour tester les 3 cas :

- NotFound : Utilise un user ADMIN et un UID incorrecte
- Restricted : Utilise un user USER et un UID dâ€™un autre user
- Error technique :

Dans `user-service`

```tsx
export const getBankAccountByUidService = async (uid: string) => {
  const canRead = await canReadOwn(uid)
  throw new Error('Une error est survenue')
```

Fichiers

- `services/user-service.ts`
- `(dashboard)/bank/[uid]/page.ts`

### 2. ğŸš€ Autorisation dans les Servers Action

Dans lâ€™exercice prÃ©cÃ¨dent nous avons vÃ©rifier lâ€™autorisation de lecture dans une route. Mais nous nâ€™avons pas protÃ©ger les actions (server actions).

MÃªme si nos routes ,ne sont pas accessibles, les serveurs actions doivent quand mÃªme Ãªtre protÃ©gÃ©s.

Rappel : _un server action expose les fonctions du serveur sous forme dâ€™api accessible_

Il est possible de protÃ©ger les actions au niveau

- du serveur action.
- du service.

ğŸ‘¨â€âœˆï¸ Hugo le Chef de projet te demande de protÃ©ger la crÃ©ation de produits avec les rÃ¨gles suivantes.

- Les `ADMIN` peuvent crÃ©er, mettre Ã  jour et supprimer des produits.
- Les `MANAGER` peuvent uniquement faire des â€œajouts rapideâ€

Nous allons ici protÃ©ger uniquement dans les servers action dans un premiers temps

ğŸ¶ Ajoute les 2 fonctions suivantes dans le service autorisation

- `canMutateProduct`
- `canQuickAddProduct`

ğŸ¶ Utilise les dans les serveurs actions

Fichier

- `services/authorization/authorization-service.ts`
- `services/product-service.ts`
- `(dashboard)/shop-admin/actions.ts`

### 3. ğŸš€ Autorisation dans les Services

ProtÃ©ger au niveau des servers actions câ€™est bien. Mais notre application peut Ãªtre amenÃ© a Ã©voluer et les services pourraient Ãªtre appelÃ©s depuis dâ€™autres layers comme

- Des API
- Des traitement (Batchs etc)

Nous allons doc protÃ©ger au niveau service.

- **ğŸ¶ Appelle** `canMutateProduct` et `canQuickAddProduct` dans product-service et gÃ¨re les `AuthorisationError` dans les serveurs action

Fichier

- `services/product-service.ts`
- `(dashboard)/shop-admin/actions.ts`

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=Clean%20Architecture&entry.533578441=06%20Authorization).
