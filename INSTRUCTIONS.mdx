# Les repositories (persistance)

### ğŸ’¡ Comprendre les repositories

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Le principe du repository est d'isoler l'accÃ¨s aux donnÃ©es en crÃ©ant une couche intermÃ©diaire qui sert d'interface entre la logique mÃ©tier et la persistance, permettant de manipuler les donnÃ©es sans dÃ©pendre directement du dÃ©tail de l'ORM ou de la base de donnÃ©es.

Pour sâ€™assurer dâ€™une bonne isolation entre la couche de lâ€™ORM et les couches supÃ©rieures (service ou, dans notre cas, prÃ©sentation), nous allons ajouter des rÃ¨gles au niveau du linter. Cela nous permettra dâ€™Ã©viter que la couche de prÃ©sentation puisse importer directement des Ã©lÃ©ments liÃ©s Ã  lâ€™ORM, comme les schÃ©mas ou les fonctions dâ€™accÃ¨s aux donnÃ©es.

### Le principe d'inversion de dÃ©pendance

Pour aller plus loin, ce dÃ©couplage repose sur le **principe dâ€™inversion de dÃ©pendance**, qui fait partie des principes SOLID. Selon ce principe :

1. **Les modules de haut niveau (prÃ©sentation ou service)** ne doivent pas dÃ©pendre des modules de bas niveau (ORM).
2. **Les deux doivent dÃ©pendre dâ€™abstractions** (par exemple, des interfaces ou des contrats dÃ©finis dans la couche repository).
3. **Les dÃ©tails dâ€™implÃ©mentation (ORM)** doivent Ãªtre dÃ©pendants des modules de haut niveau via ces abstractions.

En appliquant ce principe, nous nous assurons que :

- La couche prÃ©sentation nâ€™a aucune connaissance de la base de donnÃ©es ou des outils spÃ©cifiques (Drizzle ORM, Prisma, etc.).
- Toute modification au niveau de la base de donnÃ©es nâ€™impactera pas les couches supÃ©rieures.

```tsx
[PrÃ©sentation] ---> [Service] ---> [Repository] ---> [ORM/DB]
```

### Mise en Å“uvre technique

### Ã‰tape 1 : CrÃ©ation de la rÃ¨gle de linter

Ajoutez une rÃ¨gle Ã  votre fichier `eslint` pour empÃªcher les imports directs depuis la couche ORM dans la couche prÃ©sentation. Par exemple :

```tsx
 //eslint.config.mjs
 {
    files: ['src/app/exercices/**/*.{ts,tsx}'],
    rules: {
      'no-restricted-imports': [
        'error',
        {
          patterns: ['@/db/schema/*'],
        },
      ],
    },
  },
```

En ajoutant cette configuration, notre application est en error `no-restricted-imports`, tu peux le constater avec

```tsx
pnpm build
```

Pour simplifier les exercices nous avons regrouper tous les appels aux fonctions qui accÃ¨dent Ã  la base de donnÃ©es dans un seul fichier `exercices/data-lib.ts`

- Les `actions.ts` appellent maintenant les fonctions de `exercices/data-lib.ts`

## Exercice

Dans cet exercice tu vas devoir implÃ©menter 2 repositories pour isoler lâ€™ORM du reste de lâ€™application

- Un pour la gestion des `users` en base de donnÃ©es
- Un pour la gestion des `products` en base de donnÃ©es

Dans un repository nous implÃ©mentons gÃ©nÃ©ralement

- un CRUD
- et des fonctions plus spÃ©cifiques

**ğŸ¶** Pour cela crÃ©Ã© des `CRUD` dans `repository`

**ğŸ¶** Pour cela dÃ©place tout le code (ayant des dÃ©pendances Ã  `lâ€™orm` ) contenu dans la prÃ©sentation (`exercices/data-lib.ts`) vers la persistance (`db/repositories/`)

Note : En cas de problÃ¨me dâ€™importation sur les Types tu peux dÃ©sactiver la rÃ¨gle (nous verrons ce point dans lâ€™exercice suivant)

```tsx
// eslint-disable-next-line no-restricted-imports
import {UserAddModel} from '@/db/schema/users'
```

Fichiers

- `app/exercises/data-lib.ts`
- `db/repositories/product-repository.ts`
- `db/repositories/user-repository.ts`

## Bonus

### 1. ğŸš€ Isolation des types du model

Notre ORM (`Drizzle`) nous permet dâ€™avoir des types (typescript) en fonction du model.

Exemple :

```tsx
//src/db/schema/products.ts
export type ProductModel = typeof products.$inferSelect
export type AddProductModel = typeof products.$inferInsert
```

Nous pouvons ensuite utiliser ces types dans les signatures de nos fonctions, comme par exemple

```tsx
export async function createProduct(newProduct: AddProductModel) {
  const [createdProduct] = await db.insert(products) ...
  ...
}
```

Cela ne pose pas de problÃ¨me dans la couche de persistance. Mais au niveau des couches supÃ©rieures (prÃ©sentation / services) nous ne voulons pas avoir de dÃ©pendances avec des types de plus bas niveau. Nous ne voulons pas avoir

```tsx
import {UserAddModel} from '@/db/schema/users'
```

Fichiers

- `app/exercises/data-lib.ts`
- `types/product-types.ts`
- `types/user-types.ts`

### 2. ğŸš€ DÃ©couplage complet

Active la rÃ¨gle `'no-restricted-imports'` sur toute la couche de prÃ©sentation avec la configuration suivante : `files: ['src/app/**/*.{ts,tsx}'],`

```tsx
// eslint.config.mjs
 {
    files: ['src/app/**/*.{ts,tsx}'],
    //files: ['src/app/exercices/**/*.{ts,tsx}'], //
    rules: {
      'no-restricted-imports': [
        'error',
        {
          patterns: ['@/db/schema/*', '@/db/schema', 'drizzle-orm'],
        },
      ],
    },
  },
```

- **ğŸ¶ Fini le dÃ©couplage en remplaÃ§ant tous les types par les types dÃ©couplÃ©s**

exÃ©cute : `pnpm build` pour voir les fichiers en error

Fichiers

- `eslint.config.mjs`

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis).
